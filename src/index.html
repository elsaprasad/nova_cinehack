<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Film Production Management</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
            color: #fff;
            min-height: 100vh;
        }

        .navbar {
            background: rgba(20,20,30,0.95);
            border-bottom: 1px solid rgba(0,150,255,0.2);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .navbar h1 { color: #00d4ff; font-size: 1.5rem; }

        .container { max-width: 1400px; margin: 0 auto; padding: 2rem; }

        .progress-bar {
            display: flex;
            justify-content: space-between;
            margin: 2rem 0;
            position: relative;
        }

        .progress-bar::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 2px;
            background: rgba(0,150,255,0.2);
            z-index: 0;
        }

        .step {
            background: rgba(30,30,40,0.9);
            border: 2px solid rgba(100,100,100,0.3);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            position: relative;
            z-index: 1;
        }

        .step.active { border-color: #00d4ff; background: #00d4ff; color: #000; }
        .step.completed { border-color: #28a745; background: #28a745; }

        .card {
            background: rgba(30,30,40,0.95);
            border: 1px solid rgba(0,150,255,0.3);
            border-radius: 12px;
            padding: 2rem;
            margin: 1rem 0;
        }

        .card h2 { color: #00d4ff; margin-bottom: 1.5rem; }
        .card h3 { color: #0096ff; margin: 1.5rem 0 1rem; }

        input, textarea, select {
            width: 100%;
            padding: 12px;
            margin-bottom: 1rem;
            border: 1px solid rgba(100,100,100,0.3);
            border-radius: 8px;
            background: rgba(50,50,60,0.8);
            color: #fff;
            font-size: 14px;
        }

        button {
            padding: 12px 24px;
            background: #007bff;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        button:hover { background: #0056b3; transform: translateY(-2px); }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #218838; }
        .btn-secondary { background: rgba(100,100,100,0.3); }
        .btn-danger { background: #dc3545; }

        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }

        .scene-card {
            background: rgba(20,20,30,0.9);
            border: 1px solid rgba(0,150,255,0.2);
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1rem 0;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .badge-planned { background: rgba(108,117,125,0.3); color: #6c757d; }
        .badge-in-progress { background: rgba(255,193,7,0.3); color: #ffc107; }
        .badge-completed { background: rgba(40,167,69,0.3); color: #28a745; }

        .stat-box {
            background: linear-gradient(135deg, rgba(0,123,255,0.2), rgba(0,212,255,0.1));
            border: 1px solid rgba(0,150,255,0.3);
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
        }

        .stat-value { font-size: 2rem; font-weight: bold; color: #00d4ff; margin-bottom: 0.5rem; }
        .stat-label { font-size: 0.9rem; color: rgba(255,255,255,0.7); }

        .error, .success, .info { padding: 12px; border-radius: 8px; margin-bottom: 1rem; }
        .error { background: rgba(255,0,0,0.1); border: 1px solid rgba(255,0,0,0.3); color: #ff4444; }
        .success { background: rgba(0,255,0,0.1); border: 1px solid rgba(0,255,0,0.3); color: #44ff44; }
        .info { background: rgba(0,123,255,0.1); border: 1px solid rgba(0,123,255,0.3); color: #00d4ff; }

        .hidden { display: none; }
        .loader { border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid #007bff; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 2rem auto; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: rgba(30,30,40,0.98);
            border: 1px solid rgba(0,150,255,0.3);
            border-radius: 12px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <h1>🎬 Film Production Management</h1>
        <div id="userInfo"></div>
    </nav>

    <div class="container">
        <!-- Login/Signup -->
        <div id="authSection">
            <div class="card">
                <h2>Welcome to Film Production Management</h2>
                <div id="authError"></div>
                <input type="email" id="authEmail" placeholder="Email">
                <input type="password" id="authPassword" placeholder="Password">
                <button onclick="handleAuth()">Sign In / Sign Up</button>
            </div>
        </div>

        <!-- Main App -->
        <div id="mainApp" class="hidden">
            <div class="progress-bar">
                <div class="step active" data-step="1">1</div>
                <div class="step" data-step="2">2</div>
                <div class="step" data-step="3">3</div>
                <div class="step" data-step="4">4</div>
                <div class="step" data-step="5">5</div>
            </div>

            <!-- Phase 1 -->
            <div id="phase1" class="phase">
                <div class="card">
                    <h2>Phase 1: Project Setup & Script Analysis</h2>
                    <div id="phase1Error"></div>
                    
                    <h3>Create or Join Project</h3>
                    <input type="text" id="projectName" placeholder="Project Name">
                    <input type="password" id="projectPasskey" placeholder="Passkey">
                    <button onclick="createProject()">Create Project</button>
                    <button onclick="joinProject()" class="btn-secondary">Join Existing Project</button>

                    <div id="scriptUpload" class="hidden">
                        <h3>Upload Script for AI Analysis</h3>
                        <p class="info">Upload your script and let Gemini AI analyze it into detailed scenes</p>
                        <input type="file" id="scriptFile" accept=".txt">
                        <button onclick="analyzeScript()">Analyze with Gemini AI</button>
                        <div id="analysisLoader" class="hidden">
                            <div class="loader"></div>
                            <p style="text-align: center; color: rgba(255,255,255,0.6); margin-top: 1rem;">Analyzing script with Gemini AI...</p>
                        </div>
                    </div>
                </div>

                <div id="sceneReview" class="hidden">
                    <div class="card">
                        <h2>Review & Edit Scenes</h2>
                        <div id="scenesList"></div>
                        <button onclick="approveAllScenes()" class="btn-success">Approve & Continue to Budget Setup</button>
                    </div>
                </div>
            </div>

            <!-- Phase 2 -->
            <div id="phase2" class="phase hidden">
                <div class="card">
                    <h2>Phase 2: Budget Setup</h2>
                    <p class="info">Set estimated budget for each department per scene (in ₹ Lakhs)</p>
                    
                    <select id="budgetSceneSelector" onchange="loadBudgetForm()">
                        <option value="">Select Scene...</option>
                    </select>

                    <div id="budgetFormContainer" class="hidden">
                        <h3 id="budgetSceneTitle"></h3>
                        <div id="budgetInputs"></div>
                        <button onclick="saveBudgetNext()">Save & Next Scene</button>
                        <button onclick="completeBudgetSetup()" class="btn-success">Complete Budget Setup</button>
                    </div>
                </div>
            </div>

            <!-- Phase 3 -->
            <div id="phase3" class="phase hidden">
                <div class="card">
                    <h2>Phase 3: Daily Production Planning</h2>
                    
                    <div class="grid-2">
                        <div>
                            <label>Shoot Date:</label>
                            <input type="date" id="shootDate">
                            <button onclick="createShootDay()">Create Shoot Day</button>
                        </div>
                        <div>
                            <label>Existing Shoot Days:</label>
                            <select id="existingShootDays" onchange="loadExistingDay()">
                                <option value="">Select shoot day...</option>
                            </select>
                        </div>
                    </div>

                    <div id="sceneSelectionContainer" class="hidden">
                        <h3>Select Scenes for <span id="selectedShootDate"></span></h3>
                        <div id="sceneCheckboxes"></div>
                        <button onclick="finalizeDay()" class="btn-success">Finalize & Start Production</button>
                    </div>
                </div>
            </div>

            <!-- Phase 4 -->
            <div id="phase4" class="phase hidden">
                <div class="card">
                    <h2>Phase 4: Production Day - <span id="productionDate"></span></h2>
                    
                    <div class="grid">
                        <div class="stat-box"><div class="stat-value" id="estimatedTotal">₹0</div><div class="stat-label">Estimated Budget</div></div>
                        <div class="stat-box"><div class="stat-value" id="actualTotal">₹0</div><div class="stat-label">Actual Spent</div></div>
                        <div class="stat-box"><div class="stat-value" id="scenesProgress">0/0</div><div class="stat-label">Scenes Completed</div></div>
                    </div>

                    <h3>Today's Scenes</h3>
                    <div id="productionScenes"></div>
                    <button onclick="endDay()" class="btn-success">End Production Day</button>
                </div>
            </div>

            <!-- Phase 5 -->
            <div id="phase5" class="phase hidden">
                <div class="card">
                    <h2>Day Summary - <span id="summaryDate"></span></h2>
                    
                    <div class="grid">
                        <div class="stat-box"><div class="stat-value" id="summaryEstimated">₹0</div><div class="stat-label">Estimated</div></div>
                        <div class="stat-box"><div class="stat-value" id="summaryActual">₹0</div><div class="stat-label">Actual</div></div>
                        <div class="stat-box"><div class="stat-value" id="summaryVariance">₹0</div><div class="stat-label">Variance</div></div>
                        <div class="stat-box"><div class="stat-value" id="summaryScenes">0/0</div><div class="stat-label">Completed</div></div>
                    </div>

                    <div class="grid-2" style="margin-top: 2rem;">
                        <div class="card">
                            <h3>Department Distribution</h3>
                            <div style="position: relative; height: 300px;">
                                <canvas id="departmentChart"></canvas>
                            </div>
                        </div>
                        <div class="card">
                            <h3>Budget vs Actual</h3>
                            <div style="position: relative; height: 300px;">
                                <canvas id="comparisonChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div id="varianceReport"></div>
                    <button onclick="backToPlanning()">Plan Another Day</button>
                    <button onclick="exportSummary()" class="btn-secondary" style="margin-left: 1rem;">Export PDF</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Expense Modal -->
    <div id="expenseModal" class="modal">
        <div class="modal-content">
            <h2>Record Actual Expenses</h2>
            <div id="expenseForm"></div>
            <button onclick="saveExpenses()" class="btn-success">Save Expenses</button>
            <button onclick="closeModal()" class="btn-secondary">Cancel</button>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://teveaeieqejtofhasqae.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRldmVhZWllcWVqdG9maGFzcWFlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2MTIzMzIsImV4cCI6MjA3NTE4ODMzMn0._utlaOZt5PdH42p4HiYFQsDZPVaJjvkiq92KJCMlchw';
        const GEMINI_API_KEY = 'AIzaSyBPCGMgMvUlViM519-WqC470QDc3lLqljg'; // Add your Gemini API key here
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentUser = null;
        let currentProject = null;
        let currentShootDay = null;
        let allScenes = [];
        let currentPhase = 1;

        const DEPARTMENTS = ['Camera', 'Lighting', 'Sound', 'Art Department', 'Costumes', 'Makeup & Hair', 'Props', 'Location', 'Cast', 'Crew', 'Equipment Rental', 'Transportation', 'Catering', 'Post-Production', 'Miscellaneous'];

        // Auth
        async function handleAuth() {
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            
            try {
                let { data, error } = await supabase.auth.signInWithPassword({ email, password });
                
                if (error && error.message.includes('Invalid')) {
                    const { error: signUpError } = await supabase.auth.signUp({ email, password });
                    if (signUpError) throw signUpError;
                    ({ data, error } = await supabase.auth.signInWithPassword({ email, password }));
                }
                
                if (error) throw error;
                currentUser = data.user;
                showApp();
            } catch (error) {
                document.getElementById('authError').innerHTML = `<div class="error">${error.message}</div>`;
            }
        }

        function showApp() {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('userInfo').innerHTML = `<button onclick="logout()" class="btn-secondary">Logout</button>`;
        }

        function logout() {
            supabase.auth.signOut();
            location.reload();
        }

        // Project
        async function createProject() {
            const name = document.getElementById('projectName').value;
            const passkey = document.getElementById('projectPasskey').value;
            
            if (!name || !passkey) {
                document.getElementById('phase1Error').innerHTML = '<div class="error">Please enter project name and passkey</div>';
                return;
            }

            try {
                const { data, error } = await supabase.from('projects').insert([{
                    name,
                    passkey,
                    creator_id: currentUser.id
                }]).select();
                
                if (error) throw error;
                currentProject = data[0];
                document.getElementById('scriptUpload').classList.remove('hidden');
                document.getElementById('phase1Error').innerHTML = '<div class="success">Project created! Upload script.</div>';
            } catch (error) {
                document.getElementById('phase1Error').innerHTML = `<div class="error">${error.message}</div>`;
            }
        }

        async function joinProject() {
            const name = document.getElementById('projectName').value;
            const passkey = document.getElementById('projectPasskey').value;
            
            try {
                const { data, error } = await supabase.from('projects')
                    .select('*')
                    .eq('name', name)
                    .eq('passkey', passkey)
                    .single();
                
                if (error) throw new Error('Project not found or incorrect passkey');
                currentProject = data;
                loadExistingScenes();
            } catch (error) {
                document.getElementById('phase1Error').innerHTML = `<div class="error">${error.message}</div>`;
            }
        }

        // Gemini AI Script Analysis
        async function analyzeScript() {
            const file = document.getElementById('scriptFile').files[0];
            if (!file) {
                document.getElementById('phase1Error').innerHTML = '<div class="error">Please select a script file</div>';
                return;
            }

            document.getElementById('analysisLoader').classList.remove('hidden');
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const scriptText = e.target.result;
                    const scenes = await analyzeWithGemini(scriptText);
                    
                    // Delete existing scenes
                    await supabase.from('scenes').delete().eq('project_id', currentProject.id);
                    
                    // Insert new scenes
                    for (const scene of scenes) {
                        const { data, error } = await supabase.from('scenes').insert([{
                            project_id: currentProject.id,
                            scene_number: scene.scene_number,
                            heading: scene.heading || `Scene ${scene.scene_number}`,
                            location_type: scene.location_type || 'INT',
                            specific_location: scene.specific_location || 'Unknown',
                            time_of_day: scene.time_of_day || 'DAY',
                            characters_present: scene.characters_present,
                            speaking_roles: scene.speaking_roles,
                            extras: scene.extras,
                            functional_props: scene.functional_props,
                            decorative_props: scene.decorative_props,
                            camera_movement: scene.camera_movement,
                            framing: scene.framing,
                            lighting: scene.lighting,
                            lighting_mood: scene.lighting_mood,
                            diegetic_sounds: scene.diegetic_sounds,
                            scene_mood: scene.scene_mood,
                            emotional_arc: scene.emotional_arc,
                            primary_action: scene.primary_action,
                            pacing: scene.pacing,
                            shoot_type: scene.shoot_type,
                            content: scene.content || ''
                        }]).select();
                        
                        if (error) throw error;
                        scene.id = data[0].id;
                    }
                    
                    allScenes = scenes;
                    displayScenesForReview();
                    document.getElementById('phase1Error').innerHTML = `<div class="success">Successfully analyzed ${scenes.length} scenes with Gemini AI!</div>`;
                } catch (error) {
                    document.getElementById('phase1Error').innerHTML = `<div class="error">${error.message}</div>`;
                } finally {
                    document.getElementById('analysisLoader').classList.add('hidden');
                }
            };
            reader.readAsText(file);
        }

        async function analyzeWithGemini(scriptText) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${GEMINI_API_KEY}`;
            
            // Limit script length to avoid token issues
            const maxLength = 20000;
            const limitedScript = scriptText.length > maxLength ? scriptText.substring(0, maxLength) : scriptText;
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: `You are a professional script analyst. Analyze this film script and break it into scenes.

CRITICAL INSTRUCTIONS:
1. Return ONLY valid JSON - no explanations or markdown
2. Keep ALL field values SHORT (max 80 characters each)
3. Replace double quotes in content with single quotes
4. Be concise and direct

SCRIPT TO ANALYZE:
${limitedScript}

Return a JSON array with these fields for each scene (keep brief):
- scene_number: number
- heading: brief scene heading
- location_type: INT or EXT
- specific_location: location name
- time_of_day: DAY/NIGHT/EVENING/etc
- characters_present: character names only
- speaking_roles: speaking character names
- extras: extras description
- functional_props: key props list
- decorative_props: decorative items
- camera_movement: camera description
- framing: shot framing
- lighting: lighting description
- lighting_mood: lighting mood
- diegetic_sounds: sounds in scene
- scene_mood: emotional mood
- emotional_arc: emotion progression
- primary_action: main action
- pacing: scene pacing
- shoot_type: interior/exterior/etc
- content: scene dialogue and action (use single quotes only)`
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.2,
                            maxOutputTokens: 8000,
                            responseMimeType: "application/json"
                        }
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API Error: ${errorData.error?.message || response.statusText}`);
                }

                const result = await response.json();
                
                if (!result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    throw new Error('Invalid API response structure');
                }
                
                let jsonText = result.candidates[0].content.parts[0].text;
                
                // Aggressive cleaning
                jsonText = jsonText
                    .replace(/```json\n?/g, '')
                    .replace(/```\n?/g, '')
                    .replace(/[\u0000-\u001F]+/g, '')
                    .trim();
                
                const scenes = JSON.parse(jsonText);
                
                if (!Array.isArray(scenes) || scenes.length === 0) {
                    throw new Error('No scenes extracted from script');
                }
                
                return scenes;
                
            } catch (error) {
                console.error('Gemini error:', error);
                if (error.message.includes('JSON')) {
                    throw new Error('AI returned invalid format. Try uploading a cleaner script or contact support.');
                }
                throw new Error(`Analysis failed: ${error.message}`);
            }
        }

        function parseScript(text) {
            const lines = text.split('\n');
            const scenes = [];
            let currentScene = null;
            let sceneNumber = 0;
            
            lines.forEach(line => {
                const trimmed = line.trim();
                
                // Match: INT. COFFEE SHOP - DAY or EXT. STREET - NIGHT
                const sceneMatch = trimmed.match(/^(INT\.|EXT\.)\s+(.+?)\s+-\s+(.+)$/i);
                
                if (sceneMatch) {
                    // Save previous scene
                    if (currentScene) {
                        scenes.push(currentScene);
                    }
                    
                    sceneNumber++;
                    const locationType = sceneMatch[1].toUpperCase().replace('.', '');
                    const location = sceneMatch[2].trim();
                    const timeOfDay = sceneMatch[3].trim();
                    
                    currentScene = {
                        scene_number: sceneNumber,
                        heading: trimmed,
                        location_type: locationType,
                        specific_location: location,
                        time_of_day: timeOfDay,
                        content: trimmed + '\n'
                    };
                } else if (currentScene) {
                    currentScene.content += line + '\n';
                }
            });
            
            // Add last scene
            if (currentScene) {
                scenes.push(currentScene);
            }
            
            // Fallback if no scenes found
            if (scenes.length === 0) {
                scenes.push({
                    scene_number: 1,
                    heading: 'SCENE 1',
                    location_type: 'INT',
                    specific_location: 'Unspecified Location',
                    time_of_day: 'DAY',
                    content: text
                });
            }
            
            return scenes;
        }

        function displayScenesForReview() {
            const html = allScenes.map((s, index) => `
                <div class="scene-card">
                    <h4>Scene ${s.scene_number}: 
                        <input type="text" value="${s.heading || ''}" 
                               onchange="updateSceneField(${index}, 'heading', this.value)" 
                               style="width: 60%; display: inline-block; background: rgba(0,123,255,0.1);">
                    </h4>
                    
                    <div class="grid-2" style="margin-top: 1rem;">
                        <div>
                            <label style="color: #00d4ff; font-size: 0.9rem;">Location Type:</label>
                            <select onchange="updateSceneField(${index}, 'location_type', this.value)" style="margin-bottom: 0.5rem;">
                                <option value="INT" ${s.location_type === 'INT' ? 'selected' : ''}>INT</option>
                                <option value="EXT" ${s.location_type === 'EXT' ? 'selected' : ''}>EXT</option>
                            </select>
                        </div>
                        <div>
                            <label style="color: #00d4ff; font-size: 0.9rem;">Specific Location:</label>
                            <input type="text" value="${s.specific_location || ''}" 
                                   onchange="updateSceneField(${index}, 'specific_location', this.value)">
                        </div>
                    </div>

                    <div class="grid-2">
                        <div>
                            <label style="color: #00d4ff; font-size: 0.9rem;">Time of Day:</label>
                            <input type="text" value="${s.time_of_day || ''}" 
                                   onchange="updateSceneField(${index}, 'time_of_day', this.value)">
                        </div>
                        <div>
                            <label style="color: #00d4ff; font-size: 0.9rem;">Scene Mood:</label>
                            <input type="text" value="${s.scene_mood || ''}" 
                                   onchange="updateSceneField(${index}, 'scene_mood', this.value)">
                        </div>
                    </div>

                    <details style="margin-top: 1rem;">
                        <summary style="cursor: pointer; color: #00d4ff; font-weight: 600;">📝 Edit Advanced Details</summary>
                        <div style="margin-top: 1rem;">
                            <div class="grid-2">
                                <div>
                                    <label style="color: #00d4ff; font-size: 0.9rem;">Characters Present:</label>
                                    <input type="text" value="${s.characters_present || ''}" 
                                           onchange="updateSceneField(${index}, 'characters_present', this.value)">
                                </div>
                                <div>
                                    <label style="color: #00d4ff; font-size: 0.9rem;">Speaking Roles:</label>
                                    <input type="text" value="${s.speaking_roles || ''}" 
                                           onchange="updateSceneField(${index}, 'speaking_roles', this.value)">
                                </div>
                            </div>

                            <div class="grid-2">
                                <div>
                                    <label style="color: #00d4ff; font-size: 0.9rem;">Functional Props:</label>
                                    <input type="text" value="${s.functional_props || ''}" 
                                           onchange="updateSceneField(${index}, 'functional_props', this.value)">
                                </div>
                                <div>
                                    <label style="color: #00d4ff; font-size: 0.9rem;">Camera Movement:</label>
                                    <input type="text" value="${s.camera_movement || ''}" 
                                           onchange="updateSceneField(${index}, 'camera_movement', this.value)">
                                </div>
                            </div>

                            <div class="grid-2">
                                <div>
                                    <label style="color: #00d4ff; font-size: 0.9rem;">Lighting:</label>
                                    <input type="text" value="${s.lighting || ''}" 
                                           onchange="updateSceneField(${index}, 'lighting', this.value)">
                                </div>
                                <div>
                                    <label style="color: #00d4ff; font-size: 0.9rem;">Primary Action:</label>
                                    <input type="text" value="${s.primary_action || ''}" 
                                           onchange="updateSceneField(${index}, 'primary_action', this.value)">
                                </div>
                            </div>
                        </div>
                    </details>

                    <details style="margin-top: 1rem;">
                        <summary style="cursor: pointer; color: #0096ff;">📄 View/Edit Scene Content</summary>
                        <textarea rows="8" style="margin-top: 1rem; font-family: monospace; white-space: pre-wrap;" 
                                  onchange="updateSceneField(${index}, 'content', this.value)">${s.content || ''}</textarea>
                    </details>

                    <button onclick="saveSceneChanges(${index})" class="btn-success" style="margin-top: 1rem;">💾 Save Changes</button>
                </div>
            `).join('');
            
            document.getElementById('scenesList').innerHTML = html;
            document.getElementById('sceneReview').classList.remove('hidden');
        }

        function updateSceneField(index, field, value) {
            if (allScenes[index]) {
                allScenes[index][field] = value;
            }
        }

        async function saveSceneChanges(index) {
            const scene = allScenes[index];
            if (!scene || !scene.id) return;

            try {
                const { error } = await supabase.from('scenes')
                    .update({
                        heading: scene.heading,
                        location_type: scene.location_type,
                        specific_location: scene.specific_location,
                        time_of_day: scene.time_of_day,
                        characters_present: scene.characters_present,
                        speaking_roles: scene.speaking_roles,
                        functional_props: scene.functional_props,
                        camera_movement: scene.camera_movement,
                        lighting: scene.lighting,
                        scene_mood: scene.scene_mood,
                        primary_action: scene.primary_action,
                        content: scene.content
                    })
                    .eq('id', scene.id);

                if (error) throw error;
                
                document.getElementById('phase1Error').innerHTML = `<div class="success">Scene ${scene.scene_number} saved successfully!</div>`;
                setTimeout(() => {
                    document.getElementById('phase1Error').innerHTML = '';
                }, 2000);
            } catch (error) {
                document.getElementById('phase1Error').innerHTML = `<div class="error">Error saving: ${error.message}</div>`;
            }
        }

        async function approveAllScenes() {
            showPhase(2);
            populateBudgetSelector();
        }

        // Budget
        function populateBudgetSelector() {
            const html = allScenes.map(s => `<option value="${s.id}">Scene ${s.scene_number}: ${s.heading}</option>`).join('');
            document.getElementById('budgetSceneSelector').innerHTML = '<option value="">Select Scene...</option>' + html;
        }

        function loadBudgetForm() {
            const sceneId = document.getElementById('budgetSceneSelector').value;
            if (!sceneId) return;
            
            const scene = allScenes.find(s => s.id == sceneId);
            document.getElementById('budgetSceneTitle').textContent = `Budget for Scene ${scene.scene_number}`;
            
            const inputs = DEPARTMENTS.map(dept => `
                <div class="grid-2">
                    <label>${dept}:</label>
                    <input type="number" id="budget_${dept.replace(/\s/g, '_')}" placeholder="₹ Lakhs" step="0.01">
                </div>
            `).join('');
            
            document.getElementById('budgetInputs').innerHTML = inputs;
            document.getElementById('budgetFormContainer').classList.remove('hidden');
        }

        async function saveBudgetNext() {
            const sceneId = document.getElementById('budgetSceneSelector').value;
            
            for (const dept of DEPARTMENTS) {
                const amount = document.getElementById(`budget_${dept.replace(/\s/g, '_')}`).value;
                if (amount) {
                    await supabase.from('budget_tracking').insert([{
                        project_id: currentProject.id,
                        scene_id: sceneId,
                        department: dept,
                        item_name: `${dept} for scene`,
                        estimated_cost: parseFloat(amount) * 100000
                    }]);
                }
            }
            
            const currentIndex = allScenes.findIndex(s => s.id == sceneId);
            if (currentIndex < allScenes.length - 1) {
                document.getElementById('budgetSceneSelector').value = allScenes[currentIndex + 1].id;
                loadBudgetForm();
            }
        }

        async function completeBudgetSetup() {
            await loadExistingShootDays();
            showPhase(3);
        }

        // Planning
        async function loadExistingShootDays() {
            const { data } = await supabase.from('shoot_days')
                .select('*')
                .eq('project_id', currentProject.id);
            
            if (data) {
                const html = data.map(d => `<option value="${d.id}">${d.shoot_date}</option>`).join('');
                document.getElementById('existingShootDays').innerHTML = '<option value="">Select shoot day...</option>' + html;
            }
        }

        async function createShootDay() {
            const date = document.getElementById('shootDate').value;
            if (!date) return;
            
            const { data } = await supabase.from('shoot_days').insert([{
                project_id: currentProject.id,
                shoot_date: date
            }]).select();
            
            currentShootDay = data[0];
            document.getElementById('selectedShootDate').textContent = date;
            displaySceneCheckboxes();
            document.getElementById('sceneSelectionContainer').classList.remove('hidden');
        }

        function displaySceneCheckboxes() {
            const html = allScenes.map(s => `
                <label style="display: block; padding: 0.5rem;">
                    <input type="checkbox" value="${s.id}"> 
                    Scene ${s.scene_number}: ${s.heading}
                </label>
            `).join('');
            document.getElementById('sceneCheckboxes').innerHTML = html;
        }

        async function finalizeDay() {
            const selected = Array.from(document.querySelectorAll('#sceneCheckboxes input:checked')).map(cb => cb.value);
            
            for (const sceneId of selected) {
                await supabase.from('day_scenes').insert([{
                    shoot_day_id: currentShootDay.id,
                    scene_id: sceneId
                }]);
            }
            
            await loadProductionDay();
            showPhase(4);
        }

        // Production
        async function loadProductionDay() {
            document.getElementById('productionDate').textContent = currentShootDay.shoot_date;
            
            const { data } = await supabase.from('day_scenes')
                .select('*, scenes(*)')
                .eq('shoot_day_id', currentShootDay.id);
            
            const html = data.map(ds => `
                <div class="scene-card">
                    <h4>Scene ${ds.scenes.scene_number}: ${ds.scenes.heading}</h4>
                    <select onchange="updateStatus('${ds.id}', this.value)">
                        <option value="planned">Planned</option>
                        <option value="in_progress">In Progress</option>
                        <option value="completed">Completed</option>
                    </select>
                    <button onclick="recordExpense('${ds.id}', '${ds.scene_id}')">Record Expenses</button>
                </div>
            `).join('');
            
            document.getElementById('productionScenes').innerHTML = html;
        }

        async function updateStatus(daySceneId, status) {
            await supabase.from('day_scenes').update({ scene_status: status }).eq('id', daySceneId);
        }

        function recordExpense(daySceneId, sceneId) {
            window.currentDaySceneId = daySceneId;
            window.currentSceneId = sceneId;
            
            const form = DEPARTMENTS.map(dept => `
                <div class="grid-2">
                    <label>${dept}:</label>
                    <input type="number" id="actual_${dept.replace(/\s/g, '_')}" placeholder="Actual ₹ Lakhs" step="0.01">
                </div>
            `).join('');
            
            document.getElementById('expenseForm').innerHTML = form;
            document.getElementById('expenseModal').classList.add('active');
        }

        async function saveExpenses() {
            const { data: budgetData } = await supabase.from('budget_tracking')
                .select('department, estimated_cost')
                .eq('scene_id', window.currentSceneId);
            
            const budgetMap = {};
            budgetData.forEach(b => budgetMap[b.department] = b.estimated_cost);
            
            const varianceItems = [];
            
            for (const dept of DEPARTMENTS) {
                const amount = document.getElementById(`actual_${dept.replace(/\s/g, '_')}`).value;
                if (amount) {
                    const actualAmount = parseFloat(amount) * 100000;
                    const estimatedAmount = budgetMap[dept] || 0;
                    
                    if (actualAmount > estimatedAmount) {
                        varianceItems.push({ dept, actual: actualAmount, estimated: estimatedAmount });
                    }
                    
                    await supabase.from('actual_expenses').insert([{
                        day_scene_id: window.currentDaySceneId,
                        department: dept,
                        actual_amount: actualAmount
                    }]);
                }
            }
            
            closeModal();
            
            if (varianceItems.length > 0) {
                showVarianceReasonModal(varianceItems);
            } else {
                await loadProductionDay();
            }
        }

        function showVarianceReasonModal(items) {
            const html = items.map(item => `
                <div style="background: rgba(220,53,69,0.1); padding: 1rem; margin: 1rem 0; border-radius: 8px; border: 1px solid rgba(220,53,69,0.3);">
                    <h4 style="color: #dc3545;">${item.dept} - Over Budget</h4>
                    <p>Estimated: ₹${(item.estimated / 100000).toFixed(2)} L | Actual: ₹${(item.actual / 100000).toFixed(2)} L</p>
                    <textarea id="reason_${item.dept.replace(/\s/g, '_')}" placeholder="Explain why over budget..." rows="3" style="width: 100%;"></textarea>
                </div>
            `).join('');
            
            document.getElementById('expenseForm').innerHTML = html + `
                <button onclick="saveVarianceReasons(${JSON.stringify(items).replace(/"/g, '&quot;')})" class="btn-success">Save Reasons</button>
            `;
            document.getElementById('expenseModal').classList.add('active');
        }

        async function saveVarianceReasons(items) {
            for (const item of items) {
                const reason = document.getElementById(`reason_${item.dept.replace(/\s/g, '_')}`).value;
                
                await supabase.from('actual_expenses')
                    .update({ variance_reason: reason })
                    .eq('day_scene_id', window.currentDaySceneId)
                    .eq('department', item.dept);
            }
            
            closeModal();
            await loadProductionDay();
        }

        function closeModal() {
            document.getElementById('expenseModal').classList.remove('active');
        }

        async function endDay() {
            await supabase.from('shoot_days').update({ status: 'completed' }).eq('id', currentShootDay.id);
            await loadDaySummary();
            showPhase(5);
        }

        async function loadDaySummary() {
            document.getElementById('summaryDate').textContent = currentShootDay.shoot_date;
            
            const { data: dayScenes } = await supabase.from('day_scenes')
                .select('*, scenes(scene_number, heading)')
                .eq('shoot_day_id', currentShootDay.id);
            
            const sceneIds = dayScenes.map(ds => ds.scene_id);
            
            const { data: budgets } = await supabase.from('budget_tracking')
                .select('*')
                .in('scene_id', sceneIds);
            
            const { data: expenses } = await supabase.from('actual_expenses')
                .select('*')
                .in('day_scene_id', dayScenes.map(ds => ds.id));
            
            const totalEstimated = budgets.reduce((sum, b) => sum + parseFloat(b.estimated_cost || 0), 0);
            const totalActual = expenses.reduce((sum, e) => sum + parseFloat(e.actual_amount || 0), 0);
            const variance = totalEstimated - totalActual;
            const completedScenes = dayScenes.filter(ds => ds.scene_status === 'completed').length;
            
            document.getElementById('summaryEstimated').textContent = `₹${(totalEstimated / 100000).toFixed(2)} L`;
            document.getElementById('summaryActual').textContent = `₹${(totalActual / 100000).toFixed(2)} L`;
            document.getElementById('summaryVariance').textContent = `₹${Math.abs(variance / 100000).toFixed(2)} L`;
            document.getElementById('summaryVariance').style.color = variance >= 0 ? '#28a745' : '#dc3545';
            document.getElementById('summaryScenes').textContent = `${completedScenes}/${dayScenes.length}`;
            
            const deptData = {};
            budgets.forEach(b => {
                if (!deptData[b.department]) deptData[b.department] = { estimated: 0, actual: 0 };
                deptData[b.department].estimated += parseFloat(b.estimated_cost || 0);
            });
            expenses.forEach(e => {
                if (!deptData[e.department]) deptData[e.department] = { estimated: 0, actual: 0 };
                deptData[e.department].actual += parseFloat(e.actual_amount || 0);
            });
            
            createSummaryCharts(deptData);
            
            const overBudget = expenses.filter(e => e.variance_reason);
            if (overBudget.length > 0) {
                document.getElementById('varianceReport').innerHTML = `
                    <div class="card" style="margin-top: 2rem;">
                        <h3>Variance Explanations</h3>
                        ${overBudget.map(e => `
                            <div style="background: rgba(220,53,69,0.1); padding: 1rem; margin: 0.5rem 0; border-radius: 8px;">
                                <strong>${e.department}:</strong> ${e.variance_reason}
                            </div>
                        `).join('')}
                    </div>
                `;
            }
        }

        let deptChart, compChart;

        function createSummaryCharts(deptData) {
            const departments = Object.keys(deptData);
            const estimated = departments.map(d => deptData[d].estimated / 100000);
            const actual = departments.map(d => deptData[d].actual / 100000);
            
            if (deptChart) deptChart.destroy();
            if (compChart) compChart.destroy();
            
            const ctx1 = document.getElementById('departmentChart');
            deptChart = new Chart(ctx1.getContext('2d'), {
                type: 'pie',
                data: {
                    labels: departments,
                    datasets: [{
                        data: estimated,
                        backgroundColor: ['#007bff', '#00d4ff', '#0096ff', '#ffc107', '#28a745', '#dc3545', '#6c757d', '#17a2b8', '#fd7e14', '#e83e8c', '#20c997', '#6f42c1', '#795548', '#607d8b', '#ff5722']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#fff', font: { size: 10 } }, position: 'bottom' }
                    }
                }
            });
            
            const ctx2 = document.getElementById('comparisonChart');
            compChart = new Chart(ctx2.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: departments,
                    datasets: [
                        { label: 'Estimated', data: estimated, backgroundColor: '#007bff' },
                        { label: 'Actual', data: actual, backgroundColor: '#00d4ff' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        x: { ticks: { color: '#fff', font: { size: 9 } }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    },
                    plugins: { legend: { labels: { color: '#fff' } } }
                }
            });
        }

        function backToPlanning() {
            showPhase(3);
        }

        function exportSummary() {
            window.print();
        }

        function showPhase(phase) {
            document.querySelectorAll('.phase').forEach(p => p.classList.add('hidden'));
            document.getElementById(`phase${phase}`).classList.remove('hidden');
            
            document.querySelectorAll('.step').forEach((s, i) => {
                s.classList.remove('active', 'completed');
                if (i + 1 < phase) s.classList.add('completed');
                else if (i + 1 === phase) s.classList.add('active');
            });
        }

        async function loadExistingScenes() {
            const { data } = await supabase.from('scenes').select('*').eq('project_id', currentProject.id);
            if (data && data.length > 0) {
                allScenes = data;
                showPhase(2);
                populateBudgetSelector();
            }
        }

        supabase.auth.onAuthStateChange((event, session) => {
            if (session?.user) {
                currentUser = session.user;
                showApp();
            }
        });
    </script>
</body>
</html>
